<sequence name="ClientCreationSequence" xmlns="http://ws.apache.org/ns/synapse">
    <!-- Check if client exists -->
    <call>
        <endpoint>
            <http uri="http://localhost:5004/api/clients/search?email={//email}"/>
        </endpoint>
    </call>
    
    <filter source="get-property('axis2', 'HTTP_SC')" regex="200">
        <then>
            <property name="client_exists" value="true"/>
        </then>
        <else>
            <!-- Create new client -->
            <payloadFactory media-type="json">
                <format>
                    {
                        "first_name": "$1",
                        "last_name": "$2",
                        "email": "$3",
                        "phone": "$4"
                    }
                </format>
                <args>
                    <arg expression="//first_name"/>
                    <arg expression="//last_name"/>
                    <arg expression="//email"/>
                    <arg expression="//phone"/>
                </args>
            </payloadFactory>
            <call>
                <endpoint>
                    <http uri="http://localhost:5004/api/clients/create" method="POST"/>
                </endpoint>
            </call>
            <property name="client_exists" value="false"/>
        </else>
    </filter>
</sequence>