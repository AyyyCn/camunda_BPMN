<?xml version="1.0" encoding="UTF-8"?>
<api xmlns="http://ws.apache.org/ns/synapse" name="BookingAPI" context="/booking">
    <resource methods="POST" uri-template="/create">
        <inSequence>
            <!-- Validate input -->
            <validate source="//*[local-name()='booking']">
                <schema key="conf:/schemas/booking-schema.json"/>
                <on-fail>
                    <payloadFactory media-type="json">
                        <format>{"error": "Invalid booking data"}</format>
                    </payloadFactory>
                    <property name="HTTP_SC" value="400" scope="axis2"/>
                    <respond/>
                </on-fail>
            </validate>
            
            <!-- Check room availability -->
            <call>
                <endpoint>
                    <http uri="http://localhost:5002/api/rooms/available"/>
                </endpoint>
            </call>
            
            <!-- Create client if not exists -->
            <call>
                <endpoint>
                    <http uri="http://localhost:5004/api/clients/create" method="POST"/>
                </endpoint>
            </call>
            
            <!-- Block room -->
            <payloadFactory media-type="json">
                <format>
                    {
                        "room_id": "$1",
                        "booking_id": "$2"
                    }
                </format>
                <args>
                    <arg expression="//room_id"/>
                    <arg expression="//booking_id"/>
                </args>
            </payloadFactory>
            <call>
                <endpoint>
                    <http uri="http://localhost:5002/api/rooms/block" method="POST"/>
                </endpoint>
            </call>
            
            <!-- Create booking -->
            <call>
                <endpoint>
                    <http uri="http://localhost:5001/api/booking/create" method="POST"/>
                </endpoint>
            </call>
            
            <respond/>
        </inSequence>
        <outSequence>
            <send/>
        </outSequence>
    </resource>
    
    <resource methods="GET" uri-template="/{booking_id}">
        <inSequence>
            <call>
                <endpoint>
                    <http uri="http://localhost:5001/api/booking/{uri.var.booking_id}"/>
                </endpoint>
            </call>
            <respond/>
        </inSequence>
    </resource>
</api>